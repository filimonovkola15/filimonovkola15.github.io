<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="–ü–ª–∞–Ω –∑–∞–¥–∞—á" />
<script>
  if (window.navigator.standalone) {
    window.addEventListener('load', () => {
      setTimeout(() => {
        window.scrollTo(0, 1);
      }, 0);
    });
  }
</script>
    <title>–ü–ª–∞–Ω –∑–∞–¥–∞—á</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á */
        .done {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .small-text {
            font-size: 0.85rem;
            color: #6c757d;
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h2 class="mb-4 text-center">üìã –ü–ª–∞–Ω –∑–∞–¥–∞—á</h2>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ -->
    <div class="input-group mb-3">
        <input type="text" id="taskInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." />
        <button class="btn btn-primary" onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
    <ul id="taskList" class="list-group"></ul>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="editInput" class="form-control" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø—É–Ω–∫—Ç–∞ -->
<div class="modal fade" id="editSubModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø—É–Ω–∫—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="editSubInput" class="form-control" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" onclick="saveSubEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
    // –ú–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á
    let tasks = [];
    let currentEditIndex = null;
    let currentSubtaskParentIndex = null;
    let currentSubtaskIndex = null;

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function formatTime(date) {
        return date.toLocaleString("ru-RU", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            day: "2-digit",
            month: "2-digit",
            year: "numeric"
        });
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    function saveToStorage() {
        localStorage.setItem("tasks", JSON.stringify(tasks));
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
    function loadFromStorage() {
        const stored = localStorage.getItem("tasks");
        if (stored) {
            tasks = JSON.parse(stored).map(task => ({
                ...task,
                subtasks: task.subtasks || []
            }));
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–¥–∞—á –∏ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤
    function renderTasks() {
        const list = document.getElementById("taskList");
        list.innerHTML = "";

        tasks.forEach((task, index) => {
            const li = document.createElement("li");
            li.className = "list-group-item";

            // –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å –∑–∞–¥–∞—á–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏
            const taskHeader = document.createElement("div");
            taskHeader.className = "d-flex justify-content-between align-items-start flex-column flex-md-row";

            const content = document.createElement("div");
            content.className = "d-flex align-items-center";
            content.innerHTML = `
                <input type="checkbox" class="form-check-input me-2 mt-0" onchange="toggleDone(${index})" ${task.done ? "checked" : ""}>
                <div>
                    <div class="${task.done ? 'done' : ''}">${task.text}</div>
                    <div class="small-text">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${task.time}</div>
                </div>
            `;

            const buttons = document.createElement("div");
            buttons.innerHTML = `
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="editTask(${index})">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${index})">üóëÔ∏è</button>
            `;

            taskHeader.appendChild(content);
            taskHeader.appendChild(buttons);
            li.appendChild(taskHeader);

            // –°–ø–∏—Å–æ–∫ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤
            const sublist = document.createElement("ul");
            sublist.className = "list-group mt-2";
            task.subtasks.forEach((sub, subIndex) => {
                const subItem = document.createElement("li");
                subItem.className = "list-group-item py-1 px-2 d-flex justify-content-between align-items-center small";
                subItem.innerHTML = `
                    <span class="${sub.done ? 'done' : ''}">
                        <input type="checkbox" class="form-check-input me-2" onchange="toggleSubtask(${index}, ${subIndex})" ${sub.done ? "checked" : ""}>
                        ${sub.text}
                    </span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="editSubtask(${index}, ${subIndex})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubtask(${index}, ${subIndex})">üóëÔ∏è</button>
                    </div>
                `;
                sublist.appendChild(subItem);
            });

            // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ (–µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
            const subForm = document.createElement("div");
            if (!task.done) {
                subForm.className = "input-group mt-2";
                subForm.innerHTML = `
                    <input type="text" class="form-control form-control-sm" id="subtaskInput-${index}" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø—É–Ω–∫—Ç...">
                    <button class="btn btn-sm btn-outline-primary" onclick="addSubtask(${index})">+</button>
                `;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —á–∞—Å—Ç–∏ –∑–∞–¥–∞—á–∏ –≤ DOM
            li.appendChild(sublist);
            li.appendChild(subForm);
            list.appendChild(li);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø—É–Ω–∫—Ç–∞
            setTimeout(() => {
                const subInput = document.getElementById(`subtaskInput-${index}`);
                if (subInput) {
                    subInput.addEventListener("keydown", function (event) {
                        if (event.key === "Enter") {
                            event.preventDefault();
                            addSubtask(index);
                        }
                    });
                }
            }, 0);
        });
    }

    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
    function addTask() {
        const input = document.getElementById("taskInput");
        const value = input.value.trim();
        if (value !== "") {
            const now = new Date();
            tasks.push({
                text: value,
                time: formatTime(now),
                done: false,
                subtasks: []
            });
            input.value = "";
            saveToStorage();
            renderTasks();
        }
    }

    // –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É
    function deleteTask(index) {
        tasks.splice(index, 1);
        saveToStorage();
        renderTasks();
    }

    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    function editTask(index) {
        currentEditIndex = index;
        document.getElementById("editInput").value = tasks[index].text;
        const modal = new bootstrap.Modal(document.getElementById("editModal"));
        modal.show();
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    function saveEdit() {
        const newValue = document.getElementById("editInput").value.trim();
        if (newValue !== "") {
            tasks[currentEditIndex].text = newValue;
            saveToStorage();
            renderTasks();
            bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ (–∏ –≤—Å–µ—Ö –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤)
    function toggleDone(index) {
        const task = tasks[index];
        task.done = !task.done;
        task.subtasks.forEach(sub => sub.done = task.done);
        saveToStorage();
        renderTasks();
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø—É–Ω–∫—Ç–∞
    function addSubtask(taskIndex) {
        const input = document.getElementById(`subtaskInput-${taskIndex}`);
        const value = input.value.trim();
        if (tasks[taskIndex].done) return;
        if (value !== "") {
            tasks[taskIndex].subtasks.push({ text: value, done: false });
            input.value = "";
            saveToStorage();
            renderTasks();
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
    function toggleSubtask(taskIndex, subIndex) {
        const task = tasks[taskIndex];
        const sub = task.subtasks[subIndex];
        sub.done = !sub.done;
        task.done = task.subtasks.length > 0 && task.subtasks.every(s => s.done);
        saveToStorage();
        renderTasks();
    }

    // –£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø—É–Ω–∫—Ç
    function deleteSubtask(taskIndex, subIndex) {
        tasks[taskIndex].subtasks.splice(subIndex, 1);
        saveToStorage();
        renderTasks();
    }

    // –û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø—É–Ω–∫—Ç–∞
    function editSubtask(taskIndex, subIndex) {
        currentSubtaskParentIndex = taskIndex;
        currentSubtaskIndex = subIndex;
        document.getElementById("editSubInput").value = tasks[taskIndex].subtasks[subIndex].text;
        const modal = new bootstrap.Modal(document.getElementById("editSubModal"));
        modal.show();
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø—É–Ω–∫—Ç–∞
    function saveSubEdit() {
        const newValue = document.getElementById("editSubInput").value.trim();
        if (newValue !== "") {
            tasks[currentSubtaskParentIndex].subtasks[currentSubtaskIndex].text = newValue;
            saveToStorage();
            renderTasks();
            bootstrap.Modal.getInstance(document.getElementById("editSubModal")).hide();
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    loadFromStorage();
    renderTasks();

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á
    document.getElementById("taskInput").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            addTask();
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
