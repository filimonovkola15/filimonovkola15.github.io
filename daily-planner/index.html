<!DOCTYPE html>
<html lang="ru">
<head>
    <head>
        <meta charset="UTF-8" />
        <title>–ü–ª–∞–Ω –∑–∞–¥–∞—á</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="–ü–ª–∞–Ω –∑–∞–¥–∞—á" />
        <link rel="apple-touch-icon" href="icons/icon-180.png">
        <script>
            if (window.navigator.standalone) {
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        window.scrollTo(0, 1);
                    }, 0);
                });
            }
        </script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <style>
            .done {
                text-decoration: line-through;
                opacity: 0.6;
            }
            .small-text {
                font-size: 0.85rem;
                color: #6c757d;
            }
            .list-group-item {
                word-wrap: break-word;
            }
            @media (max-width: 576px) {
                .list-group-item {
                    padding: 0.5rem;
                }
                .btn {
                    font-size: 0.85rem;
                    padding: 0.3rem 0.6rem;
                }
            }
        </style>
    </head>
<body class="bg-light">

<div class="container py-5">
    <h2 class="mb-4 text-center">üìã –ü–ª–∞–Ω –∑–∞–¥–∞—á</h2>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ -->
    <form class="row g-2 mb-3" onsubmit="event.preventDefault(); addTask();">
        <div class="col-12 col-md-9">
            <input type="text" id="taskInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." />
        </div>
        <div class="col-12 col-md-3">
            <button class="btn btn-primary w-100" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </form>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
    <ul id="taskList" class="list-group"></ul>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="editInput" class="form-control" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø—É–Ω–∫—Ç–∞ -->
<div class="modal fade" id="editSubModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø—É–Ω–∫—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="editSubInput" class="form-control" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" onclick="saveSubEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
    let tasks = [];
    let currentEditIndex = null;
    let currentSubtaskParentIndex = null;
    let currentSubtaskIndex = null;

    function formatTime(date) {
        return date.toLocaleString("ru-RU", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            day: "2-digit",
            month: "2-digit",
            year: "numeric"
        });
    }

    function saveToStorage() {
        localStorage.setItem("tasks", JSON.stringify(tasks));
    }

    function loadFromStorage() {
        const stored = localStorage.getItem("tasks");
        if (stored) {
            tasks = JSON.parse(stored).map(task => ({
                ...task,
                subtasks: task.subtasks || []
            }));
        }
    }

    function renderTasks() {
        const list = document.getElementById("taskList");
        list.innerHTML = "";

        tasks.forEach((task, index) => {
            const li = document.createElement("li");
            li.className = "list-group-item";

            const taskHeader = document.createElement("div");
            taskHeader.className = "d-flex flex-column flex-md-row justify-content-between gap-2";

            const content = document.createElement("div");
            const checkboxId = `task-check-${index}`;
            content.className = "d-flex align-items-start gap-2";
            content.innerHTML = `
                <input type="checkbox" id="${checkboxId}" class="form-check-input mt-1" onchange="toggleDone(${index})" ${task.done ? "checked" : ""}>
                <label for="${checkboxId}" class="w-100">
                    <div class="${task.done ? 'done' : ''}">${task.text}</div>
                    <div class="small-text">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${task.time}</div>
                </label>
            `;

            const buttons = document.createElement("div");
            buttons.innerHTML = `
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="editTask(${index})">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${index})">üóëÔ∏è</button>
            `;

            taskHeader.appendChild(content);
            taskHeader.appendChild(buttons);
            li.appendChild(taskHeader);

            const sublist = document.createElement("ul");
            sublist.className = "list-group mt-2";
            task.subtasks.forEach((sub, subIndex) => {
                const subItem = document.createElement("li");
                subItem.className = "list-group-item py-1 px-2 d-flex justify-content-between align-items-center small";
                const subCheckId = `sub-check-${index}-${subIndex}`;
                subItem.innerHTML = `
                    <span class="d-flex align-items-center ${sub.done ? 'done' : ''}">
                        <input type="checkbox" id="${subCheckId}" class="form-check-input me-2" onchange="toggleSubtask(${index}, ${subIndex})" ${sub.done ? "checked" : ""}>
                        <label for="${subCheckId}" class="mb-0 w-100">${sub.text}</label>
                    </span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="editSubtask(${index}, ${subIndex})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubtask(${index}, ${subIndex})">üóëÔ∏è</button>
                    </div>
                `;
                sublist.appendChild(subItem);
            });

            const subForm = document.createElement("div");
            if (!task.done) {
                subForm.className = "input-group mt-2";
                subForm.innerHTML = `
                    <input type="text" class="form-control form-control-sm" id="subtaskInput-${index}" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø—É–Ω–∫—Ç...">
                    <button class="btn btn-sm btn-outline-primary" onclick="addSubtask(${index})">+</button>
                `;
            }

            li.appendChild(sublist);
            li.appendChild(subForm);
            list.appendChild(li);

            setTimeout(() => {
                const subInput = document.getElementById(`subtaskInput-${index}`);
                if (subInput) {
                    subInput.addEventListener("keydown", function (event) {
                        if (event.key === "Enter") {
                            event.preventDefault();
                            addSubtask(index);
                        }
                    });
                }
            }, 0);
        });
    }

    function addTask() {
        const input = document.getElementById("taskInput");
        const value = input.value.trim();
        if (value !== "") {
            const now = new Date();
            tasks.push({
                text: value,
                time: formatTime(now),
                done: false,
                subtasks: []
            });
            input.value = "";
            saveToStorage();
            renderTasks();
        }
    }

    function deleteTask(index) {
        tasks.splice(index, 1);
        saveToStorage();
        renderTasks();
    }

    function editTask(index) {
        currentEditIndex = index;
        document.getElementById("editInput").value = tasks[index].text;
        const modal = new bootstrap.Modal(document.getElementById("editModal"));
        modal.show();
    }

    function saveEdit() {
        const newValue = document.getElementById("editInput").value.trim();
        if (newValue !== "") {
            tasks[currentEditIndex].text = newValue;
            saveToStorage();
            renderTasks();
            bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
        }
    }

    function toggleDone(index) {
        const task = tasks[index];
        task.done = !task.done;
        task.subtasks.forEach(sub => sub.done = task.done);
        saveToStorage();
        renderTasks();
    }

    function addSubtask(taskIndex) {
        const input = document.getElementById(`subtaskInput-${taskIndex}`);
        const value = input.value.trim();
        if (tasks[taskIndex].done) return;
        if (value !== "") {
            tasks[taskIndex].subtasks.push({ text: value, done: false });
            input.value = "";
            saveToStorage();
            renderTasks();
        }
    }

    function toggleSubtask(taskIndex, subIndex) {
        const task = tasks[taskIndex];
        const sub = task.subtasks[subIndex];
        sub.done = !sub.done;
        task.done = task.subtasks.length > 0 && task.subtasks.every(s => s.done);
        saveToStorage();
        renderTasks();
    }

    function deleteSubtask(taskIndex, subIndex) {
        tasks[taskIndex].subtasks.splice(subIndex, 1);
        saveToStorage();
        renderTasks();
    }

    function editSubtask(taskIndex, subIndex) {
        currentSubtaskParentIndex = taskIndex;
        currentSubtaskIndex = subIndex;
        document.getElementById("editSubInput").value = tasks[taskIndex].subtasks[subIndex].text;
        const modal = new bootstrap.Modal(document.getElementById("editSubModal"));
        modal.show();
    }

    function saveSubEdit() {
        const newValue = document.getElementById("editSubInput").value.trim();
        if (newValue !== "") {
            tasks[currentSubtaskParentIndex].subtasks[currentSubtaskIndex].text = newValue;
            saveToStorage();
            renderTasks();
            bootstrap.Modal.getInstance(document.getElementById("editSubModal")).hide();
        }
    }

    loadFromStorage();
    renderTasks();

    document.getElementById("taskInput").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            addTask();
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
